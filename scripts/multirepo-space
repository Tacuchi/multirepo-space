#!/usr/bin/env bash
set -euo pipefail

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"
TMPL_DIR="$SCRIPT_DIR/templates"

# shellcheck source=../lib/detect.sh
source "$LIB_DIR/detect.sh"

# --- Globals ---
OPT_YES=false
OPT_DRY_RUN=false
OPT_VERBOSE=false

# --- Helpers ---

info()  { echo -e "\033[1;34m[info]\033[0m $*"; }
warn()  { echo -e "\033[1;33m[warn]\033[0m $*"; }
error() { echo -e "\033[1;31m[error]\033[0m $*" >&2; }
ok()    { echo -e "\033[1;32m[ok]\033[0m $*"; }

verbose() {
  $OPT_VERBOSE && info "$@"
  return 0
}

confirm() {
  if $OPT_YES; then return 0; fi
  local msg="${1:-Continue?}"
  read -rp "$msg [y/N] " answer
  [[ "$answer" =~ ^[Yy]$ ]]
}

die() {
  error "$@"
  exit 1
}

template() {
  local tmpl_file="$1"
  [[ -f "$tmpl_file" ]] || die "Template not found: $tmpl_file"
  cat "$tmpl_file"
}

write_file() {
  local dest="$1"
  local content="$2"
  if $OPT_DRY_RUN; then
    info "[dry-run] Would write: $dest"
    return 0
  fi
  mkdir -p "$(dirname "$dest")"
  echo "$content" > "$dest"
  verbose "Written: $dest"
}

# --- setup ---

cmd_setup() {
  local workspace_path="$1"; shift
  local repo_paths=("$@")

  workspace_path=$(cd "$workspace_path" && pwd)

  # Validate
  [[ -d "$workspace_path" ]] || die "Workspace path does not exist: $workspace_path"
  for rp in "${repo_paths[@]}"; do
    [[ -d "$rp" ]] || die "Repo path does not exist: $rp"
  done

  # Warn if already initialized
  if [[ -f "$workspace_path/.claude/settings.json" ]] || [[ -f "$workspace_path/AGENTS.md" ]]; then
    warn "Workspace already has configuration files."
    confirm "Overwrite existing configuration?" || { info "Aborted."; exit 0; }
  fi

  local workspace_name
  workspace_name=$(basename "$workspace_path")
  local today
  today=$(date +%Y-%m-%d)
  local N=${#repo_paths[@]}

  # Detect stacks
  info "Detecting stacks for $N repos..."

  declare -a ALIASES=()
  declare -a PRIMARY_TECHS=()
  declare -a STACK_CSVS=()
  declare -a VERIFY_CMDS_LIST=()
  declare -a REPO_ABS_PATHS=()

  for rp in "${repo_paths[@]}"; do
    local abs_rp
    abs_rp=$(cd "$rp" && pwd)
    REPO_ABS_PATHS+=("$abs_rp")

    detect_stack "$abs_rp"
    local alias_name
    alias_name=$(derive_alias "$abs_rp")

    ALIASES+=("$alias_name")
    PRIMARY_TECHS+=("$DETECT_PRIMARY_TECH")
    STACK_CSVS+=("$DETECT_STACK_CSV")
    VERIFY_CMDS_LIST+=("$DETECT_VERIFY_CMDS")
  done

  # Show summary
  echo ""
  info "Workspace: $workspace_path"
  echo ""
  printf "  %-4s %-25s %-45s %s\n" "#" "Alias" "Path" "Stack"
  printf "  %-4s %-25s %-45s %s\n" "---" "-------------------------" "---------------------------------------------" "--------------------"
  for i in "${!ALIASES[@]}"; do
    printf "  %-4s %-25s %-45s %s\n" "$((i+1))" "${ALIASES[$i]}" "${REPO_ABS_PATHS[$i]}" "${STACK_CSVS[$i]}"
  done
  echo ""

  confirm "Proceed with this configuration?" || { info "Aborted."; exit 0; }

  # --- Generate files ---

  info "Generating workspace files..."

  # 1. .claude/settings.json
  local additional_dirs=""
  for i in "${!REPO_ABS_PATHS[@]}"; do
    local comma=""
    [[ $i -lt $((N-1)) ]] && comma=","
    additional_dirs+="    \"${REPO_ABS_PATHS[$i]}\"${comma}"$'\n'
  done
  local settings_content
  settings_content=$(template "$TMPL_DIR/settings.json.tmpl")
  settings_content="${settings_content//\{\{additional_directories\}\}/$additional_dirs}"
  write_file "$workspace_path/.claude/settings.json" "$settings_content"

  # 2. AGENTS.md + CLAUDE.md
  local repos_table=""
  for i in "${!ALIASES[@]}"; do
    repos_table+="| **Repo $((i+1))** (${ALIASES[$i]}) | $(basename "${REPO_ABS_PATHS[$i]}") | \`${REPO_ABS_PATHS[$i]}\` | ${STACK_CSVS[$i]} |"$'\n'
  done

  local symlinks_table=""
  for i in "${!ALIASES[@]}"; do
    symlinks_table+="| ${ALIASES[$i]} | \`${REPO_ABS_PATHS[$i]}\` |"$'\n'
  done

  local agents_table="| \`coordinator\` | Orquesta trabajo multi-repo, delega a especialistas | Workspace completo |"$'\n'
  for i in "${!ALIASES[@]}"; do
    agents_table+="| \`${ALIASES[$i]}\` | Especialista ${PRIMARY_TECHS[$i]} | Repo $((i+1)) |"$'\n'
  done

  local instructions
  instructions=$(template "$TMPL_DIR/workspace-instructions.md.tmpl")
  instructions="${instructions//\{\{N\}\}/$N}"
  instructions="${instructions//\{\{repos_table\}\}/$repos_table}"
  instructions="${instructions//\{\{symlinks_table\}\}/$symlinks_table}"
  instructions="${instructions//\{\{agents_table\}\}/$agents_table}"
  instructions="${instructions//\{\{today\}\}/$today}"

  write_file "$workspace_path/AGENTS.md" "$instructions"
  write_file "$workspace_path/CLAUDE.md" "$instructions"

  # 3. Coordinator
  local specialist_list=""
  for i in "${!ALIASES[@]}"; do
    if [[ $i -gt 0 ]]; then
      if [[ $i -eq $((N-1)) ]]; then
        specialist_list+=" y "
      else
        specialist_list+=", "
      fi
    fi
    specialist_list+="\`${ALIASES[$i]}\`"
  done

  local coordinator
  coordinator=$(template "$TMPL_DIR/coordinator.md.tmpl")
  coordinator="${coordinator//\{\{N\}\}/$N}"
  coordinator="${coordinator//\{\{specialist_list\}\}/$specialist_list}"

  write_file "$workspace_path/.agents/coordinator.md" "$coordinator"
  write_file "$workspace_path/.claude/agents/coordinator.md" "$coordinator"

  # 4. Specialist agents
  for i in "${!ALIASES[@]}"; do
    local stack_list=""
    IFS=',' read -ra parts <<< "${STACK_CSVS[$i]}"
    for part in "${parts[@]}"; do
      part=$(echo "$part" | xargs)
      stack_list+="- $part"$'\n'
    done

    local specialist
    specialist=$(template "$TMPL_DIR/specialist.md.tmpl")
    specialist="${specialist//\{\{alias\}\}/${ALIASES[$i]}}"
    specialist="${specialist//\{\{primary_tech\}\}/${PRIMARY_TECHS[$i]}}"
    specialist="${specialist//\{\{repo_path\}\}/${REPO_ABS_PATHS[$i]}}"
    specialist="${specialist//\{\{stack_list\}\}/$stack_list}"
    specialist="${specialist//\{\{verify_cmds\}\}/${VERIFY_CMDS_LIST[$i]}}"

    write_file "$workspace_path/.agents/repo-${ALIASES[$i]}.md" "$specialist"
    write_file "$workspace_path/.claude/agents/repo-${ALIASES[$i]}.md" "$specialist"
  done

  # 5. Output directories
  write_file "$workspace_path/docs/.gitkeep" ""
  write_file "$workspace_path/scripts/.gitkeep" ""

  # 6. Symlinks
  info "Creating repo symlinks..."
  if ! $OPT_DRY_RUN; then
    mkdir -p "$workspace_path/repos"
  fi
  for i in "${!ALIASES[@]}"; do
    local link_path="$workspace_path/repos/${ALIASES[$i]}"
    if $OPT_DRY_RUN; then
      info "[dry-run] Would symlink: $link_path -> ${REPO_ABS_PATHS[$i]}"
    else
      if [[ -L "$link_path" ]]; then
        rm "$link_path"
      fi
      ln -s "${REPO_ABS_PATHS[$i]}" "$link_path"
      verbose "Symlink: ${ALIASES[$i]} -> ${REPO_ABS_PATHS[$i]}"
    fi
  done

  # 7. Sync managed blocks in external repos
  info "Syncing managed blocks in repos..."
  for i in "${!ALIASES[@]}"; do
    local verify_cmds_list=""
    if [[ -n "${VERIFY_CMDS_LIST[$i]}" ]]; then
      IFS=',' read -ra vcmds <<< "${VERIFY_CMDS_LIST[$i]}"
      for vc in "${vcmds[@]}"; do
        vc=$(echo "$vc" | xargs)
        verify_cmds_list+="- \`$vc\`"$'\n'
      done
    fi

    local block
    block=$(template "$TMPL_DIR/managed-block.md.tmpl")
    block="${block//\{\{workspace_name\}\}/$workspace_name}"
    block="${block//\{\{workspace_path\}\}/$workspace_path}"
    block="${block//\{\{alias\}\}/${ALIASES[$i]}}"
    block="${block//\{\{verify_cmds_list\}\}/$verify_cmds_list}"

    for target_file in "AGENTS.md" "CLAUDE.md"; do
      local repo_file="${REPO_ABS_PATHS[$i]}/$target_file"
      sync_managed_block "$repo_file" "$block"
    done
  done

  # 8. Verify
  if $OPT_DRY_RUN; then
    echo ""
    ok "Dry-run complete. No files were written."
  else
    info "Verifying workspace integrity..."
    local file_count=0
    while IFS= read -r -d '' _; do
      ((file_count++)) || true
    done < <(find "$workspace_path" -maxdepth 4 \( -name "*.md" -o -name "*.json" -o -name ".gitkeep" \) -not -path "*/.git/*" -print0 2>/dev/null || true)

    local symlink_count
    symlink_count=$(find "$workspace_path/repos" -maxdepth 1 -type l 2>/dev/null | wc -l | xargs || echo 0)

    echo ""
    ok "Workspace created successfully!"
    info "  Files generated: $file_count"
    info "  Symlinks created: $symlink_count"
    info "  Repos configured: $N"
    echo ""
    info "Next steps:"
    info "  cd $workspace_path && claude"
    info "  cd $workspace_path && codex"
  fi
}

sync_managed_block() {
  local target_file="$1"
  local block="$2"
  local start_marker="<!-- MULTIREPO_SPACE_MANAGED:START -->"
  local end_marker="<!-- MULTIREPO_SPACE_MANAGED:END -->"

  if $OPT_DRY_RUN; then
    info "[dry-run] Would sync managed block in: $target_file"
    return 0
  fi

  if [[ -f "$target_file" ]]; then
    local content
    content=$(cat "$target_file")
    if echo "$content" | grep -q "$start_marker"; then
      # Replace existing block
      local before after
      before=$(echo "$content" | sed "/$start_marker/,\$d")
      after=$(echo "$content" | sed "1,/$end_marker/d")
      echo "${before}${block}${after}" > "$target_file"
    else
      # Append block
      echo "" >> "$target_file"
      echo "$block" >> "$target_file"
    fi
  else
    echo "$block" > "$target_file"
  fi
  verbose "Synced managed block: $target_file"
}

# --- add ---

cmd_add() {
  local workspace_path="$1"
  local repo_path="$2"

  workspace_path=$(cd "$workspace_path" && pwd)
  repo_path=$(cd "$repo_path" && pwd)

  [[ -f "$workspace_path/AGENTS.md" ]] || die "Not a valid workspace: $workspace_path (no AGENTS.md found)"
  [[ -d "$repo_path" ]] || die "Repo path does not exist: $repo_path"

  local workspace_name
  workspace_name=$(basename "$workspace_path")
  local today
  today=$(date +%Y-%m-%d)

  detect_stack "$repo_path"
  local alias_name
  alias_name=$(derive_alias "$repo_path")

  info "Adding repo: $alias_name ($DETECT_STACK_CSV)"
  confirm "Add '$alias_name' to workspace?" || { info "Aborted."; exit 0; }

  # Update .claude/settings.json
  if [[ -f "$workspace_path/.claude/settings.json" ]]; then
    local settings
    settings=$(cat "$workspace_path/.claude/settings.json")
    # Insert new path before closing bracket
    local new_entry="    \"$repo_path\""
    settings=$(echo "$settings" | sed "s|  \]|,\n$new_entry\n  ]|")
    write_file "$workspace_path/.claude/settings.json" "$settings"
  fi

  # Create specialist agent
  local stack_list=""
  IFS=',' read -ra parts <<< "$DETECT_STACK_CSV"
  for part in "${parts[@]}"; do
    part=$(echo "$part" | xargs)
    stack_list+="- $part"$'\n'
  done

  local specialist
  specialist=$(template "$TMPL_DIR/specialist.md.tmpl")
  specialist="${specialist//\{\{alias\}\}/$alias_name}"
  specialist="${specialist//\{\{primary_tech\}\}/$DETECT_PRIMARY_TECH}"
  specialist="${specialist//\{\{repo_path\}\}/$repo_path}"
  specialist="${specialist//\{\{stack_list\}\}/$stack_list}"
  specialist="${specialist//\{\{verify_cmds\}\}/$DETECT_VERIFY_CMDS}"

  write_file "$workspace_path/.agents/repo-${alias_name}.md" "$specialist"
  write_file "$workspace_path/.claude/agents/repo-${alias_name}.md" "$specialist"

  # Create symlink
  if ! $OPT_DRY_RUN; then
    mkdir -p "$workspace_path/repos"
    local link_path="$workspace_path/repos/$alias_name"
    [[ -L "$link_path" ]] && rm "$link_path"
    ln -s "$repo_path" "$link_path"
  fi

  # Sync managed block
  local verify_cmds_list=""
  if [[ -n "$DETECT_VERIFY_CMDS" ]]; then
    IFS=',' read -ra vcmds <<< "$DETECT_VERIFY_CMDS"
    for vc in "${vcmds[@]}"; do
      vc=$(echo "$vc" | xargs)
      verify_cmds_list+="- \`$vc\`"$'\n'
    done
  fi

  local block
  block=$(template "$TMPL_DIR/managed-block.md.tmpl")
  block="${block//\{\{workspace_name\}\}/$workspace_name}"
  block="${block//\{\{workspace_path\}\}/$workspace_path}"
  block="${block//\{\{alias\}\}/$alias_name}"
  block="${block//\{\{verify_cmds_list\}\}/$verify_cmds_list}"

  for target_file in "AGENTS.md" "CLAUDE.md"; do
    sync_managed_block "$repo_path/$target_file" "$block"
  done

  # Append to workspace AGENTS.md/CLAUDE.md repos table
  local new_row="| **Repo** ($alias_name) | $(basename "$repo_path") | \`$repo_path\` | $DETECT_STACK_CSV |"
  for ws_file in "$workspace_path/AGENTS.md" "$workspace_path/CLAUDE.md"; do
    if [[ -f "$ws_file" ]] && ! $OPT_DRY_RUN; then
      sed -i '' "/^## Reglas de salida/i\\
$new_row" "$ws_file" 2>/dev/null || true
    fi
  done

  ok "Repo '$alias_name' added to workspace."
}

# --- remove ---

cmd_remove() {
  local workspace_path="$1"
  local alias_name="$2"

  workspace_path=$(cd "$workspace_path" && pwd)
  [[ -f "$workspace_path/AGENTS.md" ]] || die "Not a valid workspace: $workspace_path"

  confirm "Remove '$alias_name' from workspace?" || { info "Aborted."; exit 0; }

  # Resolve repo path from symlink before any removal
  local repo_path=""
  local link_path="$workspace_path/repos/$alias_name"
  if [[ -L "$link_path" ]]; then
    repo_path=$(readlink "$link_path")
  fi

  # Remove specialist agents
  for dir in ".agents" ".claude/agents"; do
    local agent_file="$workspace_path/$dir/repo-${alias_name}.md"
    if [[ -f "$agent_file" ]]; then
      if $OPT_DRY_RUN; then
        info "[dry-run] Would remove: $agent_file"
      else
        rm "$agent_file"
        verbose "Removed: $agent_file"
      fi
    fi
  done

  # Remove symlink
  if [[ -L "$link_path" ]]; then
    if $OPT_DRY_RUN; then
      info "[dry-run] Would remove symlink: $link_path"
    else
      rm "$link_path"
      verbose "Removed symlink: $alias_name"
    fi

    # Remove managed block from repo
    if [[ -d "$repo_path" ]]; then
      for target_file in "AGENTS.md" "CLAUDE.md"; do
        local repo_file="$repo_path/$target_file"
        if [[ -f "$repo_file" ]] && ! $OPT_DRY_RUN; then
          sed -i '' "/<!-- MULTIREPO_SPACE_MANAGED:START -->/,/<!-- MULTIREPO_SPACE_MANAGED:END -->/d" "$repo_file" 2>/dev/null || true
          verbose "Cleaned managed block: $repo_file"
        fi
      done
    fi
  fi

  # Remove from .claude/settings.json
  if [[ -f "$workspace_path/.claude/settings.json" ]] && [[ -n "$repo_path" ]] && ! $OPT_DRY_RUN; then
    local tmp_settings
    tmp_settings=$(grep -vF "$repo_path" "$workspace_path/.claude/settings.json" || true)
    # Fix trailing commas in JSON
    tmp_settings=$(echo "$tmp_settings" | sed 's/,\([[:space:]]*\]\)/\1/g')
    echo "$tmp_settings" > "$workspace_path/.claude/settings.json"
  fi

  ok "Repo '$alias_name' removed from workspace."
  warn "You may need to manually update AGENTS.md/CLAUDE.md repos table and coordinator."
}

# --- status ---

cmd_status() {
  local workspace_path="$1"
  workspace_path=$(cd "$workspace_path" && pwd)

  [[ -f "$workspace_path/AGENTS.md" ]] || die "Not a valid workspace: $workspace_path"

  local workspace_name
  workspace_name=$(basename "$workspace_path")

  echo ""
  info "Workspace: $workspace_name ($workspace_path)"
  echo ""

  # Check symlinks
  local total=0
  local healthy=0
  local broken=0

  if [[ -d "$workspace_path/repos" ]]; then
    printf "  %-25s %-10s %s\n" "Alias" "Status" "Target"
    printf "  %-25s %-10s %s\n" "-------------------------" "----------" "--------------------"
    for link in "$workspace_path/repos"/*; do
      [[ -L "$link" ]] || continue
      ((total++))
      local alias_name
      alias_name=$(basename "$link")
      local target
      target=$(readlink "$link")
      if [[ -d "$target" ]]; then
        printf "  %-25s \033[32m%-10s\033[0m %s\n" "$alias_name" "OK" "$target"
        ((healthy++))
      else
        printf "  %-25s \033[31m%-10s\033[0m %s\n" "$alias_name" "BROKEN" "$target"
        ((broken++))
      fi
    done
  fi

  echo ""

  # Check parity
  local agents_count
  agents_count=$(find "$workspace_path/.agents" -name "repo-*.md" 2>/dev/null | wc -l | xargs)
  local claude_agents_count
  claude_agents_count=$(find "$workspace_path/.claude/agents" -name "repo-*.md" 2>/dev/null | wc -l | xargs)

  local parity_status="OK"
  [[ "$agents_count" != "$claude_agents_count" ]] && parity_status="MISMATCH"

  info "Repos: $total (healthy: $healthy, broken: $broken)"
  info "Agents: .agents/=$agents_count, .claude/agents/=$claude_agents_count ($parity_status)"
  info "Config: .claude/settings.json $([ -f "$workspace_path/.claude/settings.json" ] && echo "EXISTS" || echo "MISSING")"
  info "AGENTS.md $([ -f "$workspace_path/AGENTS.md" ] && echo "EXISTS" || echo "MISSING")"
  info "CLAUDE.md $([ -f "$workspace_path/CLAUDE.md" ] && echo "EXISTS" || echo "MISSING")"
}

# --- Main ---

usage() {
  cat <<EOF
multirepo-space v$VERSION - Multi-repo workspace manager for AI coding agents

Usage:
  multirepo-space <command> [options] <args>

Commands:
  setup   <workspace_path> <repo1> [repo2...]   Scaffold a new workspace
  add     <workspace_path> <repo_path>           Add a repo to existing workspace
  remove  <workspace_path> <alias>               Detach a repo from workspace
  status  <workspace_path>                       Check workspace health

Options:
  -y, --yes       Non-interactive mode (skip confirmations)
  -n, --dry-run   Preview changes without writing
  -v, --verbose   Detailed output
  -h, --help      Show this help
  --version       Show version

Examples:
  multirepo-space setup ~/workspace ~/repos/frontend ~/repos/backend
  multirepo-space add ~/workspace ~/repos/shared-lib
  multirepo-space remove ~/workspace shared-lib
  multirepo-space status ~/workspace
EOF
}

main() {
  local cmd=""
  local args=()

  while [[ $# -gt 0 ]]; do
    case "$1" in
      -y|--yes)     OPT_YES=true ;;
      -n|--dry-run) OPT_DRY_RUN=true ;;
      -v|--verbose) OPT_VERBOSE=true ;;
      -h|--help)    usage; exit 0 ;;
      --version)    echo "multirepo-space v$VERSION"; exit 0 ;;
      *)
        if [[ -z "$cmd" ]]; then
          cmd="$1"
        else
          args+=("$1")
        fi
        ;;
    esac
    shift
  done

  case "$cmd" in
    setup)
      [[ ${#args[@]} -lt 2 ]] && die "Usage: multirepo-space setup <workspace_path> <repo1> [repo2...]"
      cmd_setup "${args[@]}"
      ;;
    add)
      [[ ${#args[@]} -ne 2 ]] && die "Usage: multirepo-space add <workspace_path> <repo_path>"
      cmd_add "${args[@]}"
      ;;
    remove)
      [[ ${#args[@]} -ne 2 ]] && die "Usage: multirepo-space remove <workspace_path> <alias>"
      cmd_remove "${args[@]}"
      ;;
    status)
      [[ ${#args[@]} -ne 1 ]] && die "Usage: multirepo-space status <workspace_path>"
      cmd_status "${args[@]}"
      ;;
    *)
      usage
      exit 1
      ;;
  esac
}

main "$@"
